<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickLolli</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
            --bg: #f5f5f7;
            --card: #ffffff;
            --text: #1d1d1f;
            --accent: #0071e3;
            --border: #d2d2d7;
            --pathogenic: #ff3b30;
            --benign: #34c759;
            --vus: #ffcc00;
            --console-bg: #1c1c1e;
            --console-text: #00ff00;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container { width: 100%; max-width: 1400px; }

        header { margin-bottom: 1.5rem; text-align: left; display: flex; justify-content: space-between; align-items: flex-end; }
        
        .search-area {
            background: var(--card);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .search-input-group {
            display: flex;
            gap: 15px;
            flex-grow: 1;
            align-items: flex-start;
        }

        .input-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .input-item label {
            font-size: 11px;
            font-weight: 600;
            color: #86868b;
        }

        input[type="text"], select {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
            transition: border-color 0.2s;
            background: white;
        }

        .slider-group { min-width: 180px; }

        button {
            padding: 10px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: opacity 0.2s;
            align-self: flex-end;
            margin-bottom: 2px;
        }

        button:hover { opacity: 0.85; }
        button.secondary { background: #e8e8ed; color: var(--text); }

        /* Side-by-Side Layout */
        .viz-main-layout {
            display: flex;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            margin-bottom: 20px;
            overflow: hidden;
            height: 600px;
        }

        #legend-area {
            width: 260px;
            flex-shrink: 0;
            background: #fafafa;
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
            font-size: 11px;
        }

        .viz-wrapper {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            background: white;
        }

        #viz-container { width: 100%; height: 100%; cursor: move; }

        .legend-section { display: flex; flex-direction: column; gap: 6px; }
        .legend-title { font-weight: 700; color: #86868b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background 0.2s, opacity 0.2s;
            user-select: none;
        }
        .legend-item:hover { background: rgba(0,0,0,0.05); }
        .legend-item.hidden { opacity: 0.3; text-decoration: line-through; }

        .swatch-circle { width: 10px; height: 10px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); }
        .swatch-rect { width: 20px; height: 10px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.1); }
        .swatch-shape { width: 12px; height: 12px; display: flex; align-items: center; justify-content: center; }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            background: var(--card);
            padding: 15px;
            border-radius: 12px;
            font-size: 12px;
            border: 1px solid var(--border);
            width: 100%;
            box-sizing: border-box;
        }

        .control-item { display: flex; flex-direction: column; gap: 4px; }
        
        .feature-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-width: 400px;
            padding: 5px;
            border: 1px dashed var(--border);
            border-radius: 8px;
            max-height: 80px;
            overflow-y: auto;
        }

        .feature-checkbox {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            background: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .console-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; }
        .console-panel { background: var(--console-bg); border-radius: 12px; color: var(--console-text); font-family: monospace; height: 300px; display: flex; flex-direction: column; overflow: hidden; }
        .console-header { background: #2c2c2e; padding: 8px 15px; font-size: 11px; text-transform: uppercase; color: #aeaeae; display: flex; justify-content: space-between; }
        #api-log { padding: 10px; overflow-y: auto; font-size: 12px; flex-grow: 1; white-space: pre-wrap; }
        .log-entry { margin-bottom: 8px; border-bottom: 1px solid #3a3a3c; padding-bottom: 4px; }
        .inspector-split { display: flex; height: 100%; flex-grow: 1; }
        .inspector-sidebar { width: 150px; border-right: 1px solid #3a3a3c; padding: 10px; overflow-y: auto; }
        .var-link { display: block; padding: 6px; cursor: pointer; font-size: 11px; color: #aeaeae; border-radius: 4px; }
        .var-link.active { background: var(--accent); color: white; }
        .inspector-window { flex-grow: 1; padding: 10px; overflow-y: auto; font-size: 12px; }

        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            visibility: hidden;
            z-index: 200;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            line-height: 1.4;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal { background: white; padding: 30px; border-radius: 20px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative; }
        .detail-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 13px; }
        .detail-table th, .detail-table td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border); }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; text-transform: uppercase; font-weight: 700; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1 style="margin:0; font-weight: 800; letter-spacing: -0.02em;">Quick <span style="color:var(--accent)">Lolli</span></h1>
            <p style="margin: 4px 0 0 0; color: #86868b;">Lollipop Plotter with Sidebar Legend & Exon Mapping</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="secondary" onclick="exportSVG()">Export SVG</button>
            <button class="secondary" onclick="resetZoom()">Reset Zoom</button>
        </div>
    </header>

    <div class="search-area">
        <div class="search-input-group">
            <div class="input-item" style="flex-grow: 1;">
                <label>Gene Symbol</label>
                <input type="text" id="geneSearch" placeholder="e.g., FGFR3, TP53..." value="FGFR3">
            </div>
            <div class="input-item slider-group">
                <label>Max Results: <span id="maxVal">100</span></label>
                <input type="range" id="sizeSlider" min="1" max="500" value="100" oninput="document.getElementById('maxVal').innerText = this.value">
            </div>
        </div>
        <button id="fetchBtn" onclick="loadGeneData()">Fetch Data</button>
    </div>

    <div class="viz-main-layout">
        <div id="legend-area">
            <span style="color:#86868b">Search for a gene to view the legend.</span>
        </div>
        <div class="viz-wrapper" id="viz-wrapper">
            <div id="viz-container"></div>
            <div id="tooltip" class="tooltip"></div>
        </div>
    </div>

    <div class="toolbar">
        <div class="control-item">
            <label>Color (Grouping)</label>
            <select id="colorMode" onchange="render()">
                <option value="clinvar">ClinVar Status (Latest)</option>
                <option value="condition">Primary Condition</option>
                <option value="type">Variant Type</option>
            </select>
        </div>
        <div class="control-item">
            <label>Highlight Search (>3 chars)</label>
            <input type="text" id="highlightFilter" placeholder="HGVS, Sig, Type..." oninput="render()">
        </div>
        <div class="control-item">
            <label>Lollipop Height</label>
            <select id="heightMode" onchange="render()">
                <option value="freq">Submissions</option>
                <option value="fixed">Uniform</option>
            </select>
        </div>
        <div class="control-item">
            <label>Base Scale</label>
            <input type="range" id="yScale" min="50" max="400" value="200" oninput="render()">
        </div>
        <div class="control-item">
            <label>Backbone Color</label>
            <input type="color" id="backboneColor" value="#e8e8ed" oninput="render()">
        </div>
        <div class="control-item">
            <label>Backbone Features</label>
            <div id="feature-list" class="feature-selector">
                <span style="color:#86868b; padding:5px">No features loaded...</span>
            </div>
        </div>
    </div>

    <div class="console-section">
        <div class="console-panel">
            <div class="console-header"><span>API Activity Log</span><span onclick="clearLogs()" style="cursor:pointer">Clear</span></div>
            <div id="api-log"></div>
        </div>
        <div class="console-panel">
            <div class="console-header">Live Variable Inspector</div>
            <div class="inspector-split">
                <div class="inspector-sidebar" id="var-sidebar">
                    <span class="var-link" onclick="inspectVar('rawData')">rawData</span>
                    <span class="var-link" onclick="inspectVar('geneInfo')">geneInfo</span>
                    <span class="var-link" onclick="inspectVar('hiddenCategories')">hiddenCategories</span>
                    <span class="var-link" onclick="inspectVar('shapeMap')">shapeMap</span>
                </div>
                <div class="inspector-window" id="inspector-output">Click a variable to inspect current value...</div>
            </div>
        </div>
    </div>
</div>

<div id="modalOverlay" class="modal-overlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <h2 id="modalTitle" style="margin-top:0">Variant Details</h2>
        <div id="modalContent"></div>
        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button class="secondary" id="exportBtn">Export JSON</button>
            <button onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

<script>
    /** --- POSITIONING & STYLE VARIABLES --- **/
    const PLOT_VERTICAL_OFFSET_RATIO = 0.72; // Moved down further to improve visual balance
    const LOLLIPOP_HEAD_SIZE = 80;
    const BACKBONE_HEIGHT = 20;
    const BACKBONE_STROKE_COLOR = "#000000";
    const BACKBONE_STROKE_WIDTH = 2;
    const CALLOUT_STAGGER_HEIGHT = 16;
    const CALLOUT_FONT_SIZE = "10px";
    const CALLOUT_LABEL_COLOR = "#86868b";
    const EXON_GAP_SIZE = 2; // Gaps between exons in pixels

    let rawData = [];
    let geneInfo = { length: 1000, features: [], exons: [], canonicalTranscript: "N/A" };
    let zoomTransform = d3.zoomIdentity;
    let selectedFeatureTypes = new Set(['DOMAIN', 'TRANSMEM']);
    let shapeMap = {};
    let hiddenCategories = new Set();
    let conditionColorScale = d3.scaleOrdinal(d3.schemeTableau10);

    const availableSymbols = [
        d3.symbolCircle, d3.symbolTriangle, d3.symbolSquare, 
        d3.symbolDiamond, d3.symbolCross, d3.symbolStar, d3.symbolWye
    ];

    function updateLegend() {
        const legendArea = d3.select("#legend-area");
        legendArea.selectAll("*").remove();

        if (rawData.length === 0) {
            legendArea.html('<span style="color:#86868b">Search for a gene to view the legend.</span>');
            return;
        }

        const colorMode = document.getElementById('colorMode')?.value || 'clinvar';

        // 1. Shapes
        const shapeSection = legendArea.append("div").attr("class", "legend-section");
        shapeSection.append("div").attr("class", "legend-title").text("Variant Effect");
        Object.keys(shapeMap).forEach(type => {
            const isHidden = hiddenCategories.has(type);
            const item = shapeSection.append("div")
                .attr("class", `legend-item ${isHidden ? 'hidden' : ''}`)
                .on("click", () => toggleCategory(type))
                .on("dblclick", () => soloCategory(type, 'type'));
            const svg = item.append("div").attr("class", "swatch-shape").append("svg").attr("width", 14).attr("height", 14).append("g").attr("transform", "translate(7,7)");
            svg.append("path").attr("d", d3.symbol().type(shapeMap[type]).size(40)).attr("fill", "#636366");
            item.append("span").text(type);
        });

        // 2. Colors
        const colorSection = legendArea.append("div").attr("class", "legend-section");
        colorSection.append("div").attr("class", "legend-title").text(colorMode === 'clinvar' ? "Significance" : (colorMode === 'type' ? "Classification" : "Primary Condition"));
        
        if (colorMode === 'clinvar') {
            [{ l: 'Pathogenic', c: 'var(--pathogenic)' }, { l: 'Benign', c: 'var(--benign)' }, { l: 'VUS', c: 'var(--vus)' }, { l: 'Unknown', c: '#8e8e93' }].forEach(s => {
                const item = colorSection.append("div").attr("class", "legend-item");
                item.append("div").attr("class", "swatch-circle").style("background", s.c);
                item.append("span").text(s.l);
            });
        } else if (colorMode === 'type') {
            const types = Object.keys(shapeMap);
            const typeScale = d3.scaleOrdinal(d3.schemeCategory10);
            types.forEach(t => {
                const isHidden = hiddenCategories.has(t);
                const item = colorSection.append("div").attr("class", `legend-item ${isHidden ? 'hidden' : ''}`)
                    .on("click", () => toggleCategory(t))
                    .on("dblclick", () => soloCategory(t, 'type'));
                item.append("div").attr("class", "swatch-circle").style("background", typeScale(t));
                item.append("span").text(t);
            });
        } else {
            const conditions = [...new Set(rawData.map(d => d.primaryCondition))];
            conditions.forEach(c => {
                const isHidden = hiddenCategories.has(c);
                const item = colorSection.append("div")
                    .attr("class", `legend-item ${isHidden ? 'hidden' : ''}`)
                    .on("click", () => toggleCategory(c))
                    .on("dblclick", () => soloCategory(c, 'condition'));
                item.append("div").attr("class", "swatch-circle").style("background", c === 'Multiple' ? '#9467bd' : (c === 'Unknown' ? '#8e8e93' : conditionColorScale(c)));
                item.append("span").text(c);
            });
        }

        if (selectedFeatureTypes.size > 0) {
            const bbSection = legendArea.append("div").attr("class", "legend-section");
            bbSection.append("div").attr("class", "legend-title").text("Backbone Features");
            const palette = d3.scaleOrdinal(d3.schemeSet3);
            Array.from(selectedFeatureTypes).forEach(type => {
                const item = bbSection.append("div").attr("class", "legend-item");
                item.append("div").attr("class", "swatch-rect").style("background", palette(type));
                item.append("span").text(type);
            });
        }
    }

    function toggleCategory(cat) {
        if (hiddenCategories.has(cat)) hiddenCategories.delete(cat);
        else hiddenCategories.add(cat);
        render();
    }

    function soloCategory(cat, source) {
        let allPossible = [];
        if (source === 'type') allPossible = Object.keys(shapeMap);
        else allPossible = [...new Set(rawData.map(d => d.primaryCondition))];
        const others = allPossible.filter(c => c !== cat);
        const isCurrentlySolo = others.every(c => hiddenCategories.has(c)) && !hiddenCategories.has(cat);
        if (isCurrentlySolo) hiddenCategories.clear();
        else { hiddenCategories.clear(); others.forEach(c => hiddenCategories.add(c)); }
        render();
    }

    function logAPI(url, status, response) {
        const log = document.getElementById('api-log');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        const timestamp = new Date().toLocaleTimeString();
        entry.innerHTML = `<span style="color:#636366">[${timestamp}]</span> <span class="log-status">${status}</span> <span class="log-url">${url.split('?')[0]}</span><div style="margin-top:4px; color:#aeaeae; font-size:10px">${JSON.stringify(response).substring(0, 150)}...</div>`;
        log.prepend(entry);
    }

    function clearLogs() { document.getElementById('api-log').innerHTML = ''; }

    function inspectVar(varName) {
        document.querySelectorAll('.var-link').forEach(l => l.classList.toggle('active', l.innerText === varName));
        const output = document.getElementById('inspector-output');
        try {
            const val = eval(varName);
            output.innerHTML = `<pre>${JSON.stringify(val, (k, v) => v instanceof Set ? Array.from(v) : (typeof v === 'function' ? '[Function]' : v), 2)}</pre>`;
        } catch(e) { output.innerText = "Error: " + e.message; }
    }

    const zoom = d3.zoom().scaleExtent([0.5, 50]).on("zoom", (event) => { 
        zoomTransform = event.transform; 
        render(); 
    });

    function escapeQueryValue(v) { return v.replace(/[\s():"']/g, m => `\\${m}`); }

    async function fetchUniprotCanonicalHumanFeatures(symbol) {
        const query = `(gene_exact:${escapeQueryValue(symbol)} OR gene:${escapeQueryValue(symbol)}) AND organism_id:9606 AND reviewed:true`;
        const searchUrl = `https://rest.uniprot.org/uniprotkb/search?query=${encodeURIComponent(query)}&format=json&size=5&fields=accession,id,gene_primary,length,protein_existence`;
        const searchResp = await fetch(searchUrl);
        const searchJson = await searchResp.json();
        logAPI(searchUrl, searchResp.status, searchJson);
        if (!searchJson.results?.length) return null;
        const entry = searchJson.results[0]; 
        const accession = entry.primaryAccession || entry.accession;
        const entryUrl = `https://rest.uniprot.org/uniprotkb/${encodeURIComponent(accession)}?format=json`;
        const entryResp = await fetch(entryUrl);
        const fullEntry = await entryResp.json();
        logAPI(entryUrl, entryResp.status, fullEntry);
        return {
            length: fullEntry.sequence?.length || 1000,
            features: (fullEntry.features || []).map(f => ({
                type: f.type, description: f.description, begin: f.location?.start?.value, end: f.location?.end?.value
            }))
        };
    }

    function findExons(features) {
        let exons = [];
        function recurse(obj) {
            if (Array.isArray(obj)) { obj.forEach(recurse); }
            else if (obj && typeof obj === 'object') {
                if (obj.type === 'exon') exons.push(obj);
                if (obj.features) recurse(obj.features);
            }
        }
        recurse(features);
        return exons;
    }

    function updateFeatureControls() {
        const container = document.getElementById('feature-list');
        if (!container) return;
        container.innerHTML = '';
        const uniqueTypes = [...new Set(geneInfo.features.map(f => f.type))].sort();
        uniqueTypes.forEach(type => {
            const label = document.createElement('label'); label.className = 'feature-checkbox';
            const isDefault = type.toUpperCase().includes('DOMAIN') || type.toUpperCase().includes('TRANSMEM');
            if (isDefault) selectedFeatureTypes.add(type);
            label.innerHTML = `<input type="checkbox" value="${type}" ${selectedFeatureTypes.has(type) ? 'checked' : ''} onchange="toggleFeatureType(this)"> ${type}`;
            container.appendChild(label);
        });
    }

    async function loadGeneData() {
        const gene = document.getElementById('geneSearch')?.value.trim().toUpperCase() || 'FGFR3';
        const size = document.getElementById('sizeSlider')?.value || 100;
        const btn = document.getElementById('fetchBtn'); 
        if (btn) { btn.innerText = "Loading..."; btn.disabled = true; }

        try {
            const uniprot = await fetchUniprotCanonicalHumanFeatures(gene);
            const varUrl = `https://myvariant.info/v1/query?q=clinvar.gene.symbol:${gene}+AND+_exists_:clinvar&fields=clinvar,snpeff&size=${size}`;
            const varRes = await fetch(varUrl);
            const vJson = await varRes.json();
            logAPI(varUrl, varRes.status, vJson);
            if(!vJson.hits?.length) throw new Error("No variants found.");

            let detectedTranscript = "N/A";
            vJson.hits.some(h => {
                const cv = h.clinvar || {};
                const rcvs = Array.isArray(cv.rcv) ? cv.rcv : (cv.rcv ? [cv.rcv] : []);
                const hgvsP = rcvs[0]?.preferred_name || h.snpeff?.ann?.[0]?.hgvs_p || "";
                if (hgvsP.startsWith("NM_")) {
                    detectedTranscript = hgvsP.split('(')[0];
                    return true;
                }
                return false;
            });

            let exonSegments = [];
            if (detectedTranscript !== "N/A") {
                const mutUrl = `https://mutalyzer.nl/api/reference_model/?reference_id=${detectedTranscript}&siblings=false&ancestors=true&descendants=true`;
                const mutRes = await fetch(mutUrl);
                const mutData = await mutRes.json();
                logAPI(mutUrl, mutRes.status, mutData);
                
                const exonFeatures = findExons(mutData.annotations?.features || []);
                exonSegments = exonFeatures.map(e => ({
                    id: e.id || e.name || "exon",
                    start_nt: (e.location?.start?.position || 0),
                    end_nt: (e.location?.end?.position || 0),
                    start: (e.location?.start?.position || 0) / 3,
                    end: (e.location?.end?.position || 0) / 3
                })).sort((a, b) => a.start - b.start);
            }

            if(uniprot) { 
                geneInfo = { ...uniprot, exons: exonSegments, canonicalTranscript: detectedTranscript }; 
                updateFeatureControls(); 
            }

            shapeMap = {};
            hiddenCategories.clear();
            let uniqueTypesFound = new Set();
            const garbage = ['not provided', 'not specified', 'not available', 'none', 'unknown', '-', 'unspecified'];

            rawData = vJson.hits.map(h => {
                const cv = h.clinvar || {};
                const rcvs = Array.isArray(cv.rcv) ? [...cv.rcv] : (cv.rcv ? [cv.rcv] : []);
                rcvs.sort((a, b) => (new Date(b.last_evaluated || 0)) - (new Date(a.last_evaluated || 0)));
                let annList = Array.isArray(h.snpeff?.ann) ? h.snpeff.ann : (h.snpeff?.ann ? [h.snpeff.ann] : []);
                let bestAnn = annList.find(ann => detectedTranscript !== "N/A" && ann.feature_id?.includes(detectedTranscript)) || annList.find(ann => ann.effect);
                const type = (bestAnn?.effect || "other").toLowerCase();
                uniqueTypesFound.add(type);

                const condMap = {};
                const uniqConds = [];
                rcvs.forEach(r => {
                    const cRaw = r.conditions.name || r.name || r.trait_name || "";
                    const name = cRaw.toLowerCase().trim();
                    if (name && !garbage.some(g => name.includes(g))) {
                        condMap[cRaw] = (condMap[cRaw] || 0) + 1;
                        if (!uniqConds.includes(cRaw)) uniqConds.push(cRaw);
                    }
                });
                console.log(condMap)
                const sortedConds = Object.entries(condMap).sort((a, b) => b[1] - a[1]);
                let primaryCondition = 'Unknown';
                if (sortedConds.length > 0) {
                    const total = Object.values(condMap).reduce((a, b) => a + b, 0);
                    const topFreq = sortedConds[0][1] / total;
                    const secondFreq = sortedConds[1] ? sortedConds[1][1] / total : 0;
                    if ((topFreq - secondFreq) > 0.1) primaryCondition = sortedConds[0][0];
                    else primaryCondition = 'Multiple';
                }

                const hgvsP = rcvs[0]?.preferred_name ?? bestAnn?.hgvs_p ?? "N/A";
                const posMatch = hgvsP.match(/p\.[A-Za-z]+(\d+)/) || hgvsP.match(/\d+/);
                const pos = posMatch ? parseInt(posMatch[1] || posMatch[0]) : Math.floor(Math.random() * geneInfo.length);

                return {
                    id: h._id, pos, hgvs_p: hgvsP, hgvs_g: h._id,
                    submissions: rcvs.length || 1, significance: rcvs[0]?.clinical_significance ?? "Unknown",
                    type, primaryCondition, raw: h, allConditions: uniqConds.length > 0 ? uniqConds.join(", ") : "Not provided"
                };
            });

            Array.from(uniqueTypesFound).sort().forEach((t, i) => shapeMap[t] = availableSymbols[i % availableSymbols.length]);
            d3.select("#viz-container").call(zoom);
            render();
        } catch (e) { alert("Error: " + e.message); }
        finally { if (btn) { btn.innerText = "Fetch Data"; btn.disabled = false; } }
    }

    function render() {
        const container = d3.select("#viz-container");
        if (container.empty()) return;
        container.selectAll("*").remove();
        
        const rect = container.node().getBoundingClientRect();
        const width = rect.width, height = rect.height, margin = { top: 0, right: 50, bottom: 0, left: 50 };
        const svg = container.append("svg").attr("width", width).attr("height", height);
        
        const g = svg.append("g")
            .attr("transform", `translate(${zoomTransform.x + margin.left}, ${zoomTransform.y + height * PLOT_VERTICAL_OFFSET_RATIO})`);

        const xScale = d3.scaleLinear().domain([0, geneInfo.length]).range([0, width - margin.left - margin.right]);
        const rescaledX = zoomTransform.rescaleX(xScale);
        
        const colorMode = document.getElementById('colorMode')?.value || 'clinvar';
        const heightMode = document.getElementById('heightMode')?.value || 'freq';
        const searchInput = document.getElementById('highlightFilter')?.value.toLowerCase() || '';
        const searching = searchInput.length > 3;
        const bbColor = document.getElementById('backboneColor')?.value || '#e8e8ed';
        const maxHeightVal = +document.getElementById('yScale')?.value || 200;

        const visible = rawData.filter(d => {
            if (colorMode === 'condition') return !hiddenCategories.has(d.primaryCondition);
            return !hiddenCategories.has(d.type);
        });

        // Dynamic BOLD Title
        svg.append("text")
            .attr("x", 20).attr("y", 35).attr("font-weight", "800").attr("font-size", "16px").attr("fill", "var(--text)")
            .text(`${(document.getElementById('geneSearch')?.value || "N/A").toUpperCase()} [${geneInfo.canonicalTranscript}] â€” ${visible.length} Variants Displayed`);

        const yScale = d3.scaleLinear().domain([0, d3.max(rawData, d => d.submissions) || 1]).range([0, -maxHeightVal]);
        const centerY = 0; 

        // Fragmented Backbone with Thick Borders
        if (geneInfo.exons.length > 0) {
            geneInfo.exons.forEach(s => {
                g.append("rect")
                    .attr("x", rescaledX(s.start)).attr("y", centerY - (BACKBONE_HEIGHT / 2))
                    .attr("width", Math.max(1, rescaledX(s.end) - rescaledX(s.start) - EXON_GAP_SIZE))
                    .attr("height", BACKBONE_HEIGHT).attr("rx", 2)
                    .attr("fill", bbColor).attr("fill-opacity", 0.6)
                    .attr("stroke", BACKBONE_STROKE_COLOR).attr("stroke-width", BACKBONE_STROKE_WIDTH)
                    .on("mouseover", (e) => showExonTooltip(e, s))
                    .on("mousemove", moveTooltip)
                    .on("mouseout", hideTooltip);
            });
        } else {
            g.append("rect")
                .attr("x", rescaledX(0)).attr("y", centerY - (BACKBONE_HEIGHT / 2))
                .attr("width", rescaledX(geneInfo.length) - rescaledX(0)).attr("height", BACKBONE_HEIGHT)
                .attr("rx", 2).attr("fill", bbColor).attr("fill-opacity", 0.6)
                .attr("stroke", BACKBONE_STROKE_COLOR).attr("stroke-width", BACKBONE_STROKE_WIDTH);
        }

        const palette = d3.scaleOrdinal(d3.schemeSet3);
        geneInfo.features.forEach((f, i) => {
            if (selectedFeatureTypes.has(f.type)) {
                g.append("rect").attr("x", rescaledX(f.begin)).attr("y", centerY - 15).attr("width", Math.max(2, rescaledX(f.end)-rescaledX(f.begin))).attr("height", 30).attr("rx", 4).attr("fill", palette(f.type)).attr("opacity", 0.6)
                 .on("mouseover", (e) => showFeatureTooltip(e, f)).on("mousemove", moveTooltip).on("mouseout", hideTooltip);

                if (f.description) {
                    const mid = rescaledX((f.begin + f.end) / 2);
                    const labelY = centerY + 80 + (i % 8 * CALLOUT_STAGGER_HEIGHT);
                    g.append("line").attr("x1", mid).attr("y1", centerY + 15).attr("x2", mid).attr("y2", labelY - 8).attr("stroke", "#d2d2d7").attr("stroke-width", 0.5);
                    g.append("text").attr("x", mid).attr("y", labelY).attr("text-anchor", "middle").attr("font-size", CALLOUT_FONT_SIZE).attr("fill", CALLOUT_LABEL_COLOR).text(f.description.length > 35 ? f.description.substring(0, 32) + "..." : f.description);
                }
            }
        });

        g.append("g").attr("transform", `translate(0, ${centerY + 25})`).call(d3.axisBottom(rescaledX).ticks(10).tickFormat(d => d + " aa"));

        const lolls = g.selectAll(".v-group").data(visible).enter().append("g");
        lolls.each(function(d) {
            const h = heightMode === 'freq' ? yScale(d.submissions) : -60;
            const match = searching && `${d.hgvs_p} ${d.significance} ${d.type} ${d.primaryCondition} ${d.allConditions}`.toLowerCase().includes(searchInput);
            const op = searching ? (match ? 1 : 0.1) : 1;
            const node = d3.select(this);
            node.append("line").attr("x1", rescaledX(d.pos)).attr("x2", rescaledX(d.pos)).attr("y1", centerY - 10).attr("y2", centerY + h).attr("stroke", match ? "var(--accent)" : "#8e8e93").attr("stroke-width", (match ? 2 : 1)/zoomTransform.k).attr("opacity", op);
            node.append("path").attr("transform", `translate(${rescaledX(d.pos)}, ${centerY + h})`).attr("d", d3.symbol().type(shapeMap[d.type] || d3.symbolCircle).size(LOLLIPOP_HEAD_SIZE)()).attr("fill", getColor(d)).attr("stroke", match ? "black" : "white").attr("stroke-width", match ? 2.5 : 1).attr("opacity", op).style("cursor", "pointer")
                .on("mouseover", (e) => showTooltip(e, d)).on("mousemove", moveTooltip).on("mouseout", hideTooltip).on("click", () => showDetails(d));
        });
        updateLegend();
    }

    function getColor(d) {
        const mode = document.getElementById('colorMode')?.value || 'clinvar';
        if (mode === 'type') return d3.scaleOrdinal(d3.schemeCategory10)(d.type);
        if (mode === 'condition') return d.primaryCondition === 'Multiple' ? '#9467bd' : (d.primaryCondition === 'Unknown' ? '#8e8e93' : conditionColorScale(d.primaryCondition));
        const sig = String(d.significance).toLowerCase();
        if(sig.includes("pathogenic")) return "var(--pathogenic)";
        if(sig.includes("benign")) return "var(--benign)";
        return sig.includes("uncertain") || sig.includes("vus") ? "var(--vus)" : "#8e8e93";
    }

    function getRel(e) { 
        const wrapper = document.getElementById('viz-wrapper').getBoundingClientRect(); 
        return { x: e.clientX - wrapper.left, y: e.clientY - wrapper.top }; 
    }

    function showTooltip(e, d) {
        const p = getRel(e); d3.select("#tooltip").style("visibility", "visible").style("left", (p.x + 15) + "px").style("top", (p.y - 10) + "px")
            .html(`<strong>${d.hgvs_p}</strong><br>Submissions: ${d.submissions}<br>Sig: ${d.significance}<br>Type: ${d.type}<br>Condition: ${d.primaryCondition}`);
    }

    function showFeatureTooltip(e, f) {
        const p = getRel(e); d3.select("#tooltip").style("visibility", "visible").style("left", (p.x + 15) + "px").style("top", (p.y - 10) + "px").html(`<strong>${f.type}</strong>: ${f.description || "N/A"}<br>AA ${f.begin}-${f.end}`);
    }

    function showExonTooltip(e, s) {
        const p = getRel(e); d3.select("#tooltip").style("visibility", "visible").style("left", (p.x + 15) + "px").style("top", (p.y - 10) + "px")
            .html(`<strong>${s.id}</strong><br>AA Range: ${Math.round(s.start)} - ${Math.round(s.end)}<br>NT Start: ${s.start_nt}<br>NT End: ${s.end_nt}`);
    }

    function moveTooltip(e) { const p = getRel(e); d3.select("#tooltip").style("left", (p.x + 15) + "px").style("top", (p.y - 10) + "px"); }
    function hideTooltip() { d3.select("#tooltip").style("visibility", "hidden"); }

    function showDetails(d) {
        document.getElementById('modalTitle').innerText = "Variant Analysis";
        document.getElementById('modalContent').innerHTML = `<table class="detail-table"><tr><th>Preferred Name</th><td>${d.hgvs_p}</td></tr><tr><th>HGVS Genomic</th><td><code>${d.hgvs_g}</code></td></tr><tr><th>Significance</th><td><span class="badge" style="background:${getColor(d)}">${d.significance}</span></td></tr><tr><th>Condition</th><td>${d.primaryCondition}</td></tr><tr><th>All Traits</th><td>${d.allConditions}</td></tr></table>`;
        document.getElementById('modalOverlay').style.display = 'flex';
        document.getElementById('exportBtn').onclick = () => { 
            const b = new Blob([JSON.stringify(d.raw, null, 2)], { type: 'application/json' }); 
            const u = URL.createObjectURL(b); 
            const l = document.createElement('a'); l.href = u; l.download = `${d.id}.json`; l.click(); 
        };
    }

    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
    function resetZoom() { d3.select("#viz-container").transition().call(zoom.transform, d3.zoomIdentity); }
    function exportSVG() { 
        const svgElement = document.querySelector("#viz-container svg");
        if (!svgElement) return;
        const s = (new XMLSerializer()).serializeToString(svgElement); 
        const l = document.createElement("a"); l.href = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(s); l.download = "gene_viz.svg"; l.click(); 
    }
</script>
</body>
</html>